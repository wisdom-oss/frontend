<div class="card block is-fullheight">
  <div
    class="card-content p-0 is-clipped is-fullheight"
    style="position: relative"
  >
    @if (mapLoadStatus() != "done") {
      <div
        loader
        style="position: absolute; z-index: 1"
        class="is-fullheight is-fullwidth is-flex is-justify-content-center is-align-items-center"
      >
        <div class="message" style="width: 60%">
          <div
            class="message-body content"
            style="border-color: var(--bulma-primary)"
          >
            <div class="level">
              <div class="level-left">
                <p
                  class="is-size-4"
                  [translate]="'water-rights.loading.map.' + mapLoadStatus()"
                ></p>
              </div>
              <div class="level-right">
                <p>[{{ mapLoadStatusIndex() }}/3]</p>
              </div>
            </div>
            <progress
              [attr.value]="
                mapLoadStatus() == 'downloading' && usageLocationSize()
                  ? usageLocationProgress()
                  : null
              "
              [attr.max]="
                mapLoadStatus() == 'downloading' && usageLocationSize()
                  ? usageLocationSize()
                  : null
              "
              class="progress is-primary"
            ></progress>
          </div>
        </div>
      </div>
    }

    <mgl-map
      class="is-fullheight skeleton-block"
      [class.skeleton-block]="mapLoadStatus() != 'done'"
      [style]="style"
      [zoom]="[6.8]"
      [center]="{lat: 52.8, lon: 9.2}"
      [cursor]="clusterHoverId() || hover()?.no ? 'pointer' : 'grab'"
      [fitBounds]="$any(fitBounds())"
      (click)="clusterHoverId() && fitBounds.set(outlineSource.polygon().bbox)"
      (click)="hover()?.no && openDetails(hover()!.waterRight!)"
      (idle)="onMapIdle()"
    >
      <ng-container controls>
        <mgl-control position="top-left" mglNavigation [showCompass]="false">
        </mgl-control>
      </ng-container>
      <ng-container sources>
        <mgl-geojson-source
          id="water-rights-source"
          [data]="usageLocations() ?? {type: 'FeatureCollection', features: []}"
          [cluster]="true"
          #waterRightsSource
        ></mgl-geojson-source>
        <mgl-geojson-source
          id="water-rights-cluster-polygon-source"
          mglClusterPolygon
          [source]="waterRightsSource"
          [data]="outlineSource.polygon()"
          [clusterId]="clusterHoverId()"
          #outlineSource="cluster-polygon"
        ></mgl-geojson-source>
      </ng-container>
      <ng-container layers>
        <mgl-layer
          id="water-rights-symbol"
          type="symbol"
          source="water-rights-source"
          [filter]="['!=', ['get', 'cluster'], true]"
          [layout]="{
            'icon-image': 'remixicon:map-pin-2-line',
            'icon-anchor': 'bottom',
            'icon-overlap': 'always',
            'text-field': ['get', 'name'],
            'text-font': ['noto_sans_regular'],
            'text-anchor': 'top',
          }"
          (layerMouseMove)="hoverId.set($any($event.features![0].id))"
          (layerMouseLeave)="hoverId.set(undefined)"
        ></mgl-layer>
        <mgl-layer
          id="water-rights-cluster-symbol"
          type="symbol"
          source="water-rights-source"
          [filter]="['==', ['get', 'cluster'], true]"
          [layout]="{
            'icon-image': 'remixicon:pin-distance-line',
          }"
          (layerMouseMove)="clusterHoverId.set($any($event.features![0].id))"
          (layerMouseLeave)="clusterHoverId.set(undefined)"
        ></mgl-layer>
        <mgl-layer
          id="water-rights-cluster-fill"
          type="fill"
          source="water-rights-cluster-polygon-source"
          [paint]="{
            'fill-color': 'black',
            'fill-opacity': 0.2,
          }"
        ></mgl-layer>
        <mgl-layer
          id="water-rights-cluster-line"
          type="line"
          source="water-rights-cluster-polygon-source"
          [paint]="{
            'line-color': 'black',
            'line-width': 2,
          }"
        ></mgl-layer>
      </ng-container>
    </mgl-map>
  </div>
</div>
