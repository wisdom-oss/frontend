@let lang = this.lang();
@let meter = this.meter();
@let meters = this.meters();
@let models = this.models();
@let model = this.model();

@let chartOptions =
  {
    barThickness: "flex",
    responsive: true,
    maintainAspectRatio: false,
    elements: {
      line: {
        tension: 0.1,
      },
    },
    scales: {
      y: {
        stacked: false,
        title: {
          display: true,
          text: "mÂ³",
        },
        grid: {
          display: true,
          color: "#000000",
          lineWidth: 0.4,
        },
        ticks: {},
      },
      x: {
        grid: {
          display: false,
          color: "#000000",
          lineWidth: 0.4,
        },
      },
    },
    plugins: {},
  };

<ng-template #modelTable modelTable let-ctx>
  <table>
    <tbody>
      @for (
        entry of [
          ["ID", ctx.model?.id],
          ["Meter", ctx.meter?.name],
          [
            "data starts at",
            ctx.model?.dataStartsAt?.locale(lang)?.format("LLL"),
          ],
          ["data ends at", ctx.model?.dataEndsAt?.locale(lang)?.format("LLL")],
          ["weather capability", ctx.model?.weatherCapability],
          ["training duration", ctx.model?.trainingDuration?.locale(lang)?.humanize()],
          ["training start", ctx.model?.trainingStart?.locale(lang)?.format("LLL")],
        ];
        track entry[0]
      ) {
        @let key = entry[0];
        @let value = entry[1];
        @if (value) {
          <tr>
            <th>{{ key }}</th>
            <td style="padding-left: 1rem">{{ value }}</td>
          </tr>
        }
      }
    </tbody>
    @if (ctx.model?.comment) {
      <tfoot>
        {{
          ctx.model?.comment
        }}
      </tfoot>
    }
  </table>
</ng-template>

<div class="is-position-relative is-fullheight is-fullwidth">
  @if (models && !model) {
    <div
      class="box is-position-absolute"
      style="
        margin: 2rem;
        height: calc(100% - 4rem);
        width: calc(100% - 4rem);
        z-index: 10;
        overflow-y: auto;
      "
    >
      <div class="level mb-4">
        <div class="level-left">
          <div class="level-item">
            <p class="title is-4 mb-0">Select Model</p>
          </div>
        </div>
        <div class="level-right">
          <div class="level-item">
            <button
              class="button"
              (click)="modelsLoading.set(true); this.models.reload()"
            >
              <span class="icon" [class.is-spinning]="modelsLoading()">
                <div>
                  <ng-icon name="remixResetRightLine"></ng-icon>
                </div>
              </span>
            </button>
          </div>
          <div class="level-item">
            <button class="button is-primary">
              <span>New Model</span>
              <span class="icon">
                <div><ng-icon name="remixArrowRightFill"></ng-icon></div>
              </span>
            </button>
          </div>
        </div>
      </div>
      <div class="grid is-col-min-20">
        @for (model of models.values(); track model.id) {
          @let meter = meters?.get(model.meter);
          <div class="cell">
            <div class="card">
              <div class="card-content">
                <ng-container
                  *ngTemplateOutlet="
                    modelTable;
                    context: {$implicit: {model, meter}}
                  "
                ></ng-container>
              </div>
              <div class="card-footer">
                <button
                  #button
                  (mouseover)="button.classList.add('has-text-primary')"
                  (mouseout)="button.classList.remove('has-text-primary')"
                  (click)="modelId.set(model.id)"
                  class="card-footer-item"
                >
                  <span class="has-text-weight-bold">Select</span>
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  @if (!models) {
    <div
      class="is-position-absolute is-fullheight is-fullwidth is-flex is-justify-content-center is-align-items-center"
    >
      <div>
        @let size = "7rem";
        <span
          class="icon is-spinning"
          [style.height]="size"
          [style.width]="size"
        >
          <div>
            <ng-icon [size]="size" name="remixLoader4Fill"></ng-icon>
          </div>
        </span>
      </div>
    </div>
  }

  <div
    class="box is-fullheight main-layout"
    [style.filter]="!model ? 'brightness(0.75)' : ''"
  >
    <div class="inner-layout is-fullheight">
      <div
        style="
          grid-area: sidebar;
          border-left: 0.1rem solid rgba(0, 0, 0, 0.25);
        "
      >
        <div class="is-flex is-fullwidth is-justify-content-flex-end">
          <button
            class="button is-primary"
            (click)="this.modelId.set(undefined)"
          >
            Change Model
          </button>
        </div>
        <div class="m-2">
          <ng-container
            *ngTemplateOutlet="modelTable; context: {$implicit: {model, meter}}"
          ></ng-container>
        </div>
      </div>
      @for (title of ["historic", "prediction"]; track title) {
        <div
          [style.grid-area]="'title-' + title"
          class="is-flex is-justify-content-center"
        >
          <p class="title is-4">{{ title }}</p>
        </div>
      }
      <div [style.grid-area]="'legend-historic'"></div>
      <div [style.grid-area]="'legend-prediction'"></div>
      <div [style.grid-area]="'chart-historic'">
        <canvas
          baseChart
          type="bar"
          class="is-fullheight is-fullwidth"
          [labels]="historicLabels()"
          [options]="chartOptions"
          [datasets]="historicDatasets()"
        ></canvas>
      </div>
      <div [style.grid-area]="'chart-prediction'">
        <canvas
          baseChart
          type="bar"
          class="is-fullheight is-fullwidth"
          [labels]="predictionLabels()"
          [options]="chartOptions"
          [datasets]="predictionDatasets()"
        ></canvas>
      </div>
    </div>
  </div>
</div>
