@let chartResolution = this.chartResolution();
@let chartOptions =
  {
    barThickness: "flex",
    responsive: true,
    maintainAspectRatio: false,
    elements: {
      line: {
        tension: 0.1,
      },
    },
    scales: {
      y: {
        stacked: false,
        title: {
          display: true,
          text: "m^3",
        },
        grid: {
          display: true,
          color: "#000000",
          lineWidth: 0.4,
        },
      },
      x: {
        title: {
          display: true,
          text: "water-demand-prediction.graph.legend.time" | translate,
        },
        grid: {
          display: false,
          color: "#000000",
          lineWidth: 0.4,
        },
        ticks: {
          callback: xTicks(chartResolution, lang()),
        },
      },
    },
    plugins: {
      legend: {
        display: false,
        labels: {
          generateLabels: legendLabel(lang()),
        },
      },
    },
  };

<div class="outer-layout box is-fullheight">
  <div class="inner-layout is-fullheight">
    <ng-container chart-resolution>
      @for (i of [0, 1]; track i; let isLast = $last) {
        <div [style.grid-area]="'resolution-' + i" [class.only-narrow]="isLast">
          <div class="buttons are-small has-addons is-right">
            @for (resolution of Service.RESOLUTIONS; track resolution) {
              <button
                class="button"
                [class.is-active]="chartResolution == resolution"
                (click)="this.chartResolution.set(resolution)"
                translate
              >
                water-demand-prediction.resolution.{{ resolution }}
              </button>
            }
          </div>
        </div>
      }
    </ng-container>
    <div chart-historic-legend [style.grid-area]="'chart-historic-legend'">
      <p class="title is-6 mb-0 has-text-centered">historic</p>
      <div class="is-flex is-justify-content-center">
        @for (item of legendItems.historic(); track item; let idx = $index) {
          <legend-item
            [color]="item.color"
            [smartmeter]="item.smartmeter"
            [resolution]="item.resolution"
            (visible)="chart.historic()?.setDatasetVisibility(idx, $event)"
          ></legend-item>
        }
      </div>
    </div>
    <div chart-historic-data [style.grid-area]="'chart-historic'">
      <canvas
        baseChart
        type="bar"
        class="is-fullheight is-fullwidth mb-4"
        [options]="chartOptions"
        [labels]="$any(chartLabels.historic())"
        [datasets]="$any(chartDatasets.historic[chartResolution]())"
      ></canvas>
    </div>
    <div chart-predicted-legend [style.grid-area]="'chart-predicted-legend'">
      <p class="title is-6 mb-0 has-text-centered">predicted</p>
      <div class="is-flex is-justify-content-center">
        @for (item of legendItems.predictions(); track item; let idx = $index) {
          <legend-item
            [color]="item.color"
            [smartmeter]="item.smartmeter"
            [resolution]="item.resolution"
            [mae]="item.mae"
            [mse]="item.mse"
            [rmse]="item.rmse"
            [r2]="item.r2"
            (visible)="chart.predictions()?.setDatasetVisibility(idx, $event)"
          ></legend-item>
        }
      </div>
    </div>
    <div chart-predicted-data [style.grid-area]="'chart-predicted'">
      <canvas
        baseChart
        type="bar"
        class="is-fullheight is-fullwidth mb-4"
        [options]="chartOptions"
        [labels]="$any(chartLabels.predictions())"
        [datasets]="$any(chartDatasets.predictions[chartResolution]())"
      ></canvas>
    </div>
    <div buttons [style.grid-area]="'buttons'">
      <div
        class="buttons are-medium is-centered"
        style="--bulma-control-size: 0.9rem"
      >
        <div class="buttons has-addons mb-0">
          @let disableHistoric =
            !chartDatasets.historic[chartResolution]().length;
          @let disablePredictions =
            !chartDatasets.predictions[chartResolution]().length;
          <button
            class="button is-danger"
            [disabled]="disableHistoric"
            (click)="clearSmartmeterDatasets('historic')"
          >
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixHistoryFill"></ng-icon>
            </span>
          </button>
          <button
            class="button is-danger"
            [disabled]="disableHistoric && disablePredictions"
            (click)="clearSmartmeterDatasets()"
          >
            <span translate="water-demand-prediction.delete.normal"></span>
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixDeleteBin2Line"></ng-icon>
            </span>
          </button>
          <button
            class="button is-danger"
            [disabled]="disablePredictions"
            (click)="clearSmartmeterDatasets('predictions')"
          >
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixSparklingFill"></ng-icon>
            </span>
          </button>
        </div>
        @let isTraining = this.isTraining();
        <button
          class="button is-primary"
          [disabled]="!params.predictions() || isTraining"
          (click)="trainModel()"
        >
          <span class="has-stack">
            <span [class.is-invisible]="!isTraining">Training</span>
            <span [class.is-invisible]="isTraining">Train selected model</span>
          </span>
          @if (isTraining) {
            <span class="icon is-large">
              @for (i of [1, 2, 3]; track i; let isFirst = $first) {
                @let animationDuration = 0.9;
                <div
                  [class.is-position-absolute]="!isFirst"
                  class="is-spinning"
                  [style.animation-duration.s]="animationDuration"
                  [style.animation-delay.s]="(-i * animationDuration) / 3"
                >
                  <ng-icon size="1.2em" name="remixLoader"></ng-icon>
                </div>
              }
            </span>
          } @else {
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixPingPongLine"></ng-icon>
            </span>
          }
        </button>
        <div class="buttons has-addons mb-0">
          <button
            class="button is-info"
            [disabled]="!fetched.historic()"
            (click)="pushSmartmeterDataset('historic')"
          >
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixHistoryFill"></ng-icon>
            </span>
          </button>
          <button
            class="button is-info"
            [disabled]="!fetched.historic() && !fetched.predictions()"
            (click)="pushSmartmeterDataset()"
          >
            <span translate>Add to Graph</span>
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixBarChartFill"></ng-icon>
            </span>
          </button>
          <button
            class="button is-info"
            [disabled]="!fetched.predictions()"
            (click)="pushSmartmeterDataset('predictions')"
          >
            <span class="icon is-large">
              <ng-icon size="1.2em" name="remixSparklingFill"></ng-icon>
            </span>
          </button>
        </div>
      </div>
    </div>
    <div choices [style.grid-area]="'choices'">
      <div
        class="buttons are-small is-centered"
        style="--bulma-control-size: 0.8rem; gap: 0.5rem"
      >
        <dropdown
          menuName="water-demand-prediction.choice.resolution"
          [changeMenuName]="true"
          [maxWidth]="true"
          [is-up]="true"
          [options]="options.resolution"
          kind="hover"
          [(choice)]="choices.resolution"
        ></dropdown>
        <dropdown
          menuName="water-demand-prediction.choice.timeframe"
          [changeMenuName]="true"
          [maxWidth]="true"
          [is-up]="true"
          [options]="options.timeframe()"
          kind="hover"
          [(choice)]="choices.timeframe"
        ></dropdown>
        <dropdown
          menuName="water-demand-prediction.choice.smartmeter"
          [changeMenuName]="true"
          [maxWidth]="true"
          [is-up]="true"
          [options]="options.smartmeter()"
          kind="hover"
          [(choice)]="choices.smartmeter"
        ></dropdown>
        <dropdown
          menuName="water-demand-prediction.choice.start-point"
          [changeMenuName]="true"
          [maxWidth]="true"
          [is-up]="true"
          [options]="options.startPoint"
          kind="hover"
          [(choice)]="choices.startPoint"
        ></dropdown>
        <dropdown
          menuName="water-demand-prediction.choice.weather"
          [changeMenuName]="true"
          [maxWidth]="true"
          [is-up]="true"
          [options]="options.weatherCapability"
          kind="hover"
          [(choice)]="choices.weatherCapability"
        ></dropdown>
        <dropdown
          menuName="water-demand-prediction.choice.weatherColumn"
          [changeMenuName]="true"
          [maxWidth]="true"
          [is-up]="true"
          [options]="options.weatherColumn()"
          [disabled]="options.weatherColumn() | empty"
          kind="hover"
          [(choice)]="choices.weatherColumn"
        ></dropdown>
      </div>
    </div>
  </div>
</div>
