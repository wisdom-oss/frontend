<div class="card block is-fullheight is-flex is-flex-direction-column">
  <div class="card-content p-0 is-clipped is-flex-grow-1 is-fullheight">
    <mgl-map
      class="is-fullheight"
      [style]="style"
      [zoom]="[6.8]"
      [center]="{lat: 52.8, lon: 9.2}"
      [canvasContextAttributes]="{preserveDrawingBuffer: true}"
      [attributionControl]="false"
    >
      @let groundwaterMeasurementStations =
        service.data.groundwaterMeasurementStations();
      @let groundwaterBodies = service.data.groundwaterBodies();
      @let ndsMunicipals = service.data.ndsMunicipals();
      @let waterRightUsageLocations = service.data.waterRightUsageLocations();
      @let oldWaterRightUsageLocations =
        service.data.oldWaterRightUsageLocations();
      <ng-container images>
        @for (color of measurementColors | keyvalue; track color.key) {
          <mgl-image
            [id]="'measurement-classification-' + color.key + '-image'"
            [url]="
              '/public/generated/groundwater-level-station-marker/' +
              color.key +
              '.png'
            "
          ></mgl-image>
        }
      </ng-container>
      <ng-container controls>
        <mgl-control position="top-right">
          <growl-layer-selection-control
            [layers]="selectedLayers"
          ></growl-layer-selection-control>
        </mgl-control>
        <mgl-control
          mglNavigation
          [showCompass]="false"
          position="top-left"
        ></mgl-control>
        <mgl-control
          mglAttribution
          position="bottom-right"
          [compact]="true"
          [customAttribution]="[attribution()]"
        ></mgl-control>
        <!-- using ng-containers we can ensure this ordering -->
        <ng-container>
          @if (selectedLayers.groundwaterLevelStations()) {
            <mgl-control position="bottom-left">
              <!-- the type structure is too complex for Angular here -->
              <growl-legend-control
                [count]="$any(service.data.measurementClassificationCount())"
              ></growl-legend-control>
            </mgl-control>
          }
        </ng-container>
        <ng-container>
          @let groundwaterBody = hoveredFeatures.groundwaterBody();
          @if (groundwaterBody) {
            <mgl-control position="bottom-left">
              <growl-display-info-control
                [data]="displayGroundwaterBody(groundwaterBody)"
              ></growl-display-info-control>
            </mgl-control>
          }
        </ng-container>
        <ng-container>
          @let ndsMunicipal = hoveredFeatures.ndsMunicipal();
          @if (ndsMunicipal) {
            <mgl-control position="bottom-left">
              <growl-display-info-control
                [data]="displayNdsMunicipal(ndsMunicipal)"
              ></growl-display-info-control>
            </mgl-control>
          }
        </ng-container>
        <ng-container>
          @let groundwaterMeasurementStation =
            hoveredFeatures.groundwaterMeasurementStation();
          @if (groundwaterMeasurementStation) {
            <mgl-control position="bottom-left">
              <growl-display-info-control
                [data]="
                  displayGroundwaterMeasurementStation(
                    groundwaterMeasurementStation
                  )
                "
              ></growl-display-info-control>
            </mgl-control>
          }
        </ng-container>
      </ng-container>
      <ng-container sources>
        <mgl-geojson-source
          id="groundwater-bodies-source"
          [data]="groundwaterBodies"
        ></mgl-geojson-source>
        <mgl-geojson-source id="nds-municipals-source" [data]="ndsMunicipals">
        </mgl-geojson-source>
        <mgl-geojson-source
          id="groundwater-measurement-stations-source"
          [data]="groundwaterMeasurementStations"
        ></mgl-geojson-source>
        <mgl-geojson-source
          id="water-right-usage-locations-source"
          [data]="waterRightUsageLocations"
          [cluster]="true"
        >
        </mgl-geojson-source>
        <mgl-geojson-source
          id="old-water-right-usage-locations-source"
          [data]="oldWaterRightUsageLocations"
          [cluster]="true"
        >
        </mgl-geojson-source>
      </ng-container>
      <ng-container layers *ngIf="selectedLayersUpdate()">
        <ng-container groundwater-bodies>
          @if (
            groundwaterBodies.features.length &&
            selectedLayers.groundwaterBodies()
          ) {
            <mgl-layer
              id="groundwater-bodies-layer-fill"
              type="fill"
              source="groundwater-bodies-source"
              [paint]="{
                'fill-color': '#0088aa',
                'fill-opacity': 0.3,
              }"
              (layerMouseMove)="
                hoveredFeatures.groundwaterBody.set($any($event.features![0]!))
              "
              (layerMouseLeave)="hoveredFeatures.groundwaterBody.set(null)"
            ></mgl-layer>
            <mgl-layer
              id="groundwater-bodies-layer-line"
              type="line"
              source="groundwater-bodies-source"
              [paint]="{
                'line-color': '#0088aa',
                'line-width': 3,
              }"
            ></mgl-layer>
          }
        </ng-container>
        <ng-container nds-municipals>
          @if (
            ndsMunicipals.features.length && selectedLayers.ndsMunicipals()
          ) {
            <mgl-layer
              id="nds-municipals-layer-fill"
              type="fill"
              source="nds-municipals-source"
              [paint]="{'fill-opacity': 0}"
              (layerMouseMove)="
                hoveredFeatures.ndsMunicipal.set($any($event.features![0]!))
              "
              (layerMouseLeave)="hoveredFeatures.ndsMunicipal.set(null)"
            ></mgl-layer>
            <mgl-layer
              id="nds-municipals-layer-line"
              type="line"
              source="nds-municipals-source"
              [paint]="{
                'line-color': 'black',
                'line-width': 2,
              }"
            ></mgl-layer>
          }
        </ng-container>
        <ng-container groundwater-measurement-stations>
          @if (
            groundwaterMeasurementStations.features.length &&
            selectedLayers.groundwaterLevelStations()
          ) {
            @for (color of measurementColors | keyvalue; track color.key) {
              <!-- prettier-ignore -->
              <mgl-layer
                [id]="'groundwater-measurement-stations-layer-' + color.key + '-symbol'"
                type="symbol"
                source="groundwater-measurement-stations-source"
                [layout]="{
                  'icon-image': 'measurement-classification-' + color.key + '-image',
                  'icon-size': ['interpolate', ['linear'], ['zoom'], 5, 0.1, 12, 1],
                  'icon-ignore-placement': true,
                  'symbol-z-order': 'source',
                }"
                [filter]="['==', ['get', 'classification'], '' + color.key]"
                (layerMouseMove)="
                  hoveredFeatures.groundwaterMeasurementStation.set(
                    $any($event.features![0]!)
                  )
                "
                (layerMouseLeave)="
                  hoveredFeatures.groundwaterMeasurementStation.set(null)
                "
              ></mgl-layer>
            }
          }
        </ng-container>
        <ng-container water-right-usage-locations>
          @if (
            waterRightUsageLocations.features.length &&
            selectedLayers.waterRightUsageLocations()
          ) {
            <mgl-layer
              id="water-right-usage-locations-layer-symbol"
              type="symbol"
              source="water-right-usage-locations-source"
              [filter]="['!=', ['get', 'cluster'], true]"
              [layout]="{
                'icon-image': 'remixicon:map-pin-2-fill',
                'icon-anchor': 'bottom',
                'icon-size': 1.2,
              }"
              [paint]="{
                'icon-color': 'blue',
              }"
            ></mgl-layer>
            <mgl-layer
              id="water-right-usage-locations-layer-symbol-cluster"
              type="symbol"
              source="water-right-usage-locations-source"
              [filter]="['==', ['get', 'cluster'], true]"
              [layout]="{
                'icon-image': 'remixicon:checkbox-multiple-blank-line',
                'icon-anchor': 'center',
                'icon-size': 1.2,
                'icon-offset': [0, -20],
                'text-field': ['get', 'point_count_abbreviated'],
                'text-font': ['noto_sans_regular'],
                'text-size': 20,
                'text-offset': [0, 0.1],
              }"
              [paint]="{
                'icon-color': 'blue',
              }"
            ></mgl-layer>
          }
        </ng-container>
        <ng-container old-water-right-usage-locations>
          @if (
            oldWaterRightUsageLocations.features.length &&
            selectedLayers.oldWaterRightUsageLocations()
          ) {
            <mgl-layer
              id="old-water-right-usage-locations-layer-symbol"
              type="symbol"
              source="old-water-right-usage-locations-source"
              [layout]="{
                'icon-image': 'remixicon:map-pin-2-fill',
                'icon-anchor': 'bottom',
                'icon-size': 1.2,
              }"
              [paint]="{
                'icon-color': 'red',
              }"
            ></mgl-layer>
          }
        </ng-container>
      </ng-container>
    </mgl-map>
  </div>
  <div class="card-content">
    @for (i of [1, 2, 3]; track i) {
      <button
        class="button mr-2"
        (click)="service.selectMeasurementsDay.set($any(i))"
      >
        {{ i }}
      </button>
    }
  </div>
</div>
